<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link rel="stylesheet" type='text/css' href='styles.css'/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="probeapi.js"></script>
<title>WurmTerm</title>
</head>
<body>
	<div class='main'>
		<h1>WurmTerm üêõ</h1>
		<div id='nodes'>
		</div>
	</div>

	<script>
		var hosts = {};
		var pAPI = new ProbeAPI();

		function multiMatch(text, severities) {
		  	var matchResult = undefined;
			$.each(['critical','warning'], function(i, name) {
				if(severities[name] === undefined)
					return;

				var re = new RegExp(severities[name]);
				var matches = re.exec(text);
				if(matches !== null) {
					//console.log(text+re+" result: "+name);
					matchResult = name;
					return;
				}
			});
			return matchResult;
		}

		// Note: mutates d.probeSeverity
		function markSeverity(s, d) {
				if(d['render'] === undefined || d.render['severity'] === undefined)
					return s;

				switch(multiMatch(s, d.render.severity)) {
					case 'critical':
						d.probeSeverity = 'critical'
					    return "<span class='severity_critical'>"+s+"</span>";
					case 'warning':
						if(d.probeSeverity === undefined)
							d.probeSeverity = 'warning'
					    return "<span class='severity_warning'>"+s+"</span>";
					default:
						return s;
				}
		}

		function renderString(d) {
			var res = new Array();
			$.each(JSON.stringify(d.stdout).split(/\\n/), function(i, line) {
				res.push(markSeverity(line.replace(/\"/g, ""), d));
			});
			return res.join('<br/>');
 		}

		function renderTable(d) {
			var res = "<table>";
			var re = new RegExp(d.render.split);
			$.each(d.stdout.split(/\n/), function(i, line) {
				res += "<tr>";
				$.each(line.split(re), function(j, column) {
					res += "<td>"+markSeverity(column, d)+"</td>";
				});
				res += "</tr>";
			});
			return res + "</table>";
		}

		function triggerProbe(name) {
			$.getJSON("/probe/"+name, {}).
			done(function(d) {
				console.log("done /probe! "+JSON.stringify(d));
			})
			.fail(function(data) {
				console.log("fail /probe! "+d);
			})
		}

		function getAPI(name, callback, errorcb, params) {
			if(undefined !== params) {
				name += "?" + params.map(function(obj) {
					var k = Object.keys(obj)[0];
					return k + "=" + obj[k];
				}).join("&");
			}

			return $.getJSON("/api/" + name, {})
			.done(function(data) {
				callback(data);
			})
			.fail(function(j, t, e) {
				if(errorcb)
					errorcb(e);
				else
					error('Fetching API results for "'+name+'" failed!?<br/><br/>Exception: ' + e);
			}).promise();
		}

		function probeErrorCb(e, probe, h) {
			console.err(`probe Error: host=${h} probe=${probe} `+e);
			// FIXME
		}

		function hostToId(h) {
			return h.replace(/[^a-zA-Z0-9]/g, '');
		}

		function probeResultCb(probe, h, d) {
			var hId = hostToId(h);
console.log(h);
			if(!$(`#${hId}`).length) {
				$('#nodes').append(`<div id="${hId}" class='node'>
						<div class='name'></div>
						<div class='status'></div>
						<div class='boxes'></div>
				</div>`);
			}
			$(`#${hId}.node .name`).html(h);
			$(`#${hId}.node .status`).html('connected');

			var id = "box_"+hId+"_"+d.name.replace(/[. ]/g, "_");
			if(!$(`#${id}`).length) {
				$(`#${hId} .boxes`).append(`
					<div class='box' collapsed='1' autocollapse='1' forcecollapse='0' id='`+id+`'>
						<div class='head clearfix'>
							<div class='title'>`+d.name+`</div>
							<div class='reload' title='Reload probe'>
								<a href='javascript:triggerProbe("`+d.name+`")'>&#10227;</a>
							</div>
						</div>
						<div class='error'></div>
						<div class='content'/>
					</div>`);
			}

			var tmp = "";

			if('render' in d) {
				if(d.render.type === 'table') {
					tmp += renderTable(d);
				} else if(d.render.type === 'lines') {
					tmp += renderString(d);
				} else {
					tmp += "<div class='error'>Fatal: unknown renderer type "+probe.render.type+"</div>";
					probe.probeSeverity = 'invalid';
				}
			} else {
				tmp = renderString(d);
			}

			if(d.probeSeverity === undefined)
				$('.box#'+id)
					.removeClass('problem')
					.addClass('ok')
					.attr('collapsed', $('.box#'+id).attr('autocollapse'))
			else
				$('.box#'+id)
					.removeClass('ok')
					.addClass('problem')
					.addClass('severity_'+ d.probeSeverity)
					.attr('collapsed', $('.box#'+id).attr('forcecollapse'))

			$('#'+id+' .content').html(tmp);

			// Auto-collapse rendering
			$('.box[collapsed=1] .content').hide();
			$('.box[collapsed=0] .content').show();


			$('.box .head .title').off().click(function() {
				var box = $(this).parent().parent();

				if(1 == box.attr('collapsed'))
					box
						.attr('collapsed', 0)
						.attr('autocollapse', 0)
						.attr('forcecollapse', 0)
						.find('.content').show();
				else
					box
						.attr('collapsed', 1)
						.attr('autocollapse', 1)
						.attr('forcecollapse', 1)
						.find('.content').hide();
			});

			var list = document.querySelector(`#${hId} .boxes`);
			var result = [...list.children]
				.sort((a,b)=>a.innerText>b.innerText?1:-1)
				.map(node=>list.appendChild(node))
		}

		(function() {
			$.getJSON("/api/hosts", {})
			.done(function(d) {
				$.each(d, function(i, h) {
					pAPI.start(h, probeResultCb, probeErrorCb);
				});
			})
			.fail(function(data) {
				console.err("failed fetching /api/hosts! "+d);
			})
		})();
	</script>
</body>
</html>
